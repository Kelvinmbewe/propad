generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VERIFIER
  AGENT
  LANDLORD
  USER
}

enum PropertyType {
  ROOM
  COTTAGE
  HOUSE
  PLOT
  SALE
}

enum Currency {
  USD
  ZWG
}

enum PropertyStatus {
  DRAFT
  PENDING_VERIFY
  VERIFIED
  ARCHIVED
}

enum MediaKind {
  IMAGE
  VIDEO
}

enum VerificationMethod {
  AUTO
  CALL
  SITE
  DOCS
}

enum VerificationResult {
  PASS
  FAIL
}

enum LeadSource {
  WEB
  WHATSAPP
  FACEBOOK
  SHORTLINK
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CLOSED
}

enum AgencyMemberRole {
  OWNER
  MANAGER
  AGENT
}

enum AgencyStatus {
  PENDING
  ACTIVE
  SUSPENDED
}

enum ManagementContractScope {
  LETTING_ONLY
  FULL_MANAGEMENT
}

enum ManagementFeeType {
  FLAT
  PERCENT
}

enum ManagementContractStatus {
  DRAFT
  ACTIVE
  ENDED
  TERMINATED
}

enum RewardEventType {
  LISTING_VERIFIED
  LEAD_VALID
  SALE_CONFIRMED
  BONUS_TIER
  PROMO_REBATE
}

enum PayoutMethod {
  ECOCASH
  BANK
  WALLET
}

enum PayoutStatus {
  PENDING
  PAID
  FAILED
}

enum PromoTier {
  LITE
  PLUS
  TOP
}

enum PolicyStrikeReason {
  VIEWING_FEE
  SCAM
  MISREPRESENTATION
}

enum AdvertiserStatus {
  ACTIVE
  PAUSED
  SUSPENDED
}

enum AdCreativeType {
  IMAGE
  HTML
  SCRIPT
}

enum AdPlacementPage {
  HOME
  SEARCH
  DETAIL
  ARTICLE
  GLOBAL
}

enum AdPlacementPosition {
  HEADER
  SIDEBAR
  INLINE
  FOOTER
  INTERSTITIAL
}

enum AdCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
}

model User {
  id        String   @id @default(cuid())
  role      Role     @default(USER)
  name      String?
  phone     String?
  email     String?  @unique
  kycStatus String?
  status    String?
  createdAt DateTime @default(now())

  agentProfile    AgentProfile?
  landlordProfile LandlordProfile?
  propertiesOwned Property[]      @relation("AgentOwnerProperties")
  properties      Property[]      @relation("LandlordProperties")
  leads           Lead[]
  verifications   Verification[]  @relation("VerificationVerifier")
  rewardEvents    RewardEvent[]
  payouts         Payout[]
  adImpressions   AdImpression[]
  promoBoosts     PromoBoost[]
  policyStrikes   PolicyStrike[]
  agentAssignments    AgentAssignment[]    @relation("AgentAssignments")
  landlordAssignments AgentAssignment[]    @relation("LandlordAgentAssignments")
  sentMessages        PropertyMessage[]    @relation("MessageSender")
  receivedMessages    PropertyMessage[]    @relation("MessageRecipient")
  dealConfirmations   Property[]           @relation("PropertyDealConfirmer")
  agencyMemberships   AgencyMember[]
  landlordContracts   ManagementContract[] @relation("LandlordManagementContracts")
}

model AgentProfile {
  userId                String @id
  bio                   String?
  rating                Float  @default(0)
  verifiedListingsCount Int    @default(0)
  leadsCount            Int    @default(0)
  strikesCount          Int    @default(0)
  kycStatus             String?

  user User @relation(fields: [userId], references: [id])
}

model LandlordProfile {
  userId      String   @id
  companyName String?
  verifiedAt  DateTime?

  user User @relation(fields: [userId], references: [id])
}

model Agency {
  id        String        @id @default(cuid())
  name      String
  licenseNo String?
  email     String?
  phone     String?
  address   String?
  logoUrl   String?
  kycStatus String?
  status    AgencyStatus  @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  members    AgencyMember[]
  contracts  ManagementContract[]
  properties Property[]

  @@index([status])
  @@index([name])
}

model AgencyMember {
  id        String           @id @default(cuid())
  agencyId  String
  userId    String
  role      AgencyMemberRole
  joinedAt  DateTime         @default(now())
  isActive  Boolean          @default(true)

  agency Agency @relation(fields: [agencyId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@unique([agencyId, userId])
  @@index([userId, role])
}

model ManagementContract {
  id         String                     @id @default(cuid())
  agencyId   String
  landlordId String
  startAt    DateTime
  endAt      DateTime?
  scope      ManagementContractScope
  feeType    ManagementFeeType
  feeValue   Decimal                    @db.Decimal(12, 2)
  notes      String?
  status     ManagementContractStatus   @default(DRAFT)
  createdAt  DateTime                   @default(now())
  updatedAt  DateTime                   @updatedAt

  agency   Agency @relation(fields: [agencyId], references: [id])
  landlord User   @relation("LandlordManagementContracts", fields: [landlordId], references: [id])

  @@index([agencyId, status])
  @@index([landlordId])
}

model Property {
  id           String         @id @default(cuid())
  landlordId   String?
  agentOwnerId String?
  agencyId     String?
  type         PropertyType
  currency     Currency
  price        Decimal        @db.Decimal(12, 2)
  city         String
  suburb       String?
  latitude     Float?
  longitude    Float?
  bedrooms     Int?
  bathrooms    Int?
  amenities    String[]       @default([])
  description  String?
  status       PropertyStatus @default(DRAFT)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  verifiedAt   DateTime?
  dealConfirmedAt DateTime?
  dealConfirmedById String?
  isManaged   Boolean        @default(false)

  landlord     User?           @relation("LandlordProperties", fields: [landlordId], references: [id])
  agentOwner   User?           @relation("AgentOwnerProperties", fields: [agentOwnerId], references: [id])
  agency       Agency?         @relation(fields: [agencyId], references: [id])
  dealConfirmedBy User?        @relation("PropertyDealConfirmer", fields: [dealConfirmedById], references: [id])
  media        PropertyMedia[]
  verifications Verification[]
  leads        Lead[]
  adImpressions AdImpression[]
  promoBoosts  PromoBoost[]
  assignments  AgentAssignment[]
  messages     PropertyMessage[]

  @@index([status])
  @@index([city, suburb])
  @@index([price])
  @@index([verifiedAt])
  @@index([dealConfirmedAt])
  @@index([createdAt(sort: Desc)])
  @@index([agencyId])
  @@index([isManaged])
}

model AgentAssignment {
  id                 String   @id @default(cuid())
  propertyId         String
  landlordId         String
  agentId            String
  serviceFeeUsdCents Int?
  landlordPaysFee    Boolean  @default(true)
  createdAt          DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id])
  landlord User     @relation("LandlordAgentAssignments", fields: [landlordId], references: [id])
  agent    User     @relation("AgentAssignments", fields: [agentId], references: [id])

  @@index([propertyId, createdAt(sort: Desc)])
}

model PropertyMessage {
  id          String   @id @default(cuid())
  propertyId  String
  senderId    String
  recipientId String
  body        String
  createdAt   DateTime @default(now())
  readAt      DateTime?

  property  Property @relation(fields: [propertyId], references: [id])
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])
  recipient User     @relation("MessageRecipient", fields: [recipientId], references: [id])

  @@index([propertyId, createdAt])
  @@index([recipientId, readAt])
}

model PropertyMedia {
  id         String  @id @default(cuid())
  propertyId String
  url        String
  kind       MediaKind
  exifJson   Json?
  hasGps     Boolean
  shotAt     DateTime?

  property Property @relation(fields: [propertyId], references: [id])
}

model Verification {
  id          String               @id @default(cuid())
  propertyId  String
  verifierId  String?
  method      VerificationMethod
  result      VerificationResult
  notes       String?
  evidenceUrl String?
  createdAt   DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id])
  verifier User?    @relation("VerificationVerifier", fields: [verifierId], references: [id])
}

model Lead {
  id           String     @id @default(cuid())
  propertyId   String
  userId       String?
  source       LeadSource
  channelRef   String?
  contactPhone String
  status       LeadStatus @default(NEW)
  createdAt    DateTime   @default(now())

  property Property @relation(fields: [propertyId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])

  @@index([propertyId, source])
  @@index([createdAt(sort: Desc)])
}

model RewardEvent {
  id        String           @id @default(cuid())
  agentId   String
  type      RewardEventType
  points    Int
  usdCents  Int
  refId     String?
  createdAt DateTime @default(now())

  agent User @relation(fields: [agentId], references: [id])

  @@index([agentId, createdAt(sort: Desc)])
}

model Payout {
  id             String        @id @default(cuid())
  agentId        String
  amountUsdCents Int
  method         PayoutMethod
  status         PayoutStatus @default(PENDING)
  txRef          String?
  createdAt      DateTime @default(now())

  agent User @relation(fields: [agentId], references: [id])
}

model Advertiser {
  id           String            @id @default(cuid())
  name         String
  contactEmail String?
  phone        String?
  billingInfo  Json?
  status       AdvertiserStatus @default(ACTIVE)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  campaigns   AdCampaign[]
  creatives   AdCreative[]
  impressions AdImpression[]

  @@index([status])
}

model AdCreative {
  id            String         @id @default(cuid())
  advertiserId  String
  type          AdCreativeType
  assetUrl      String?
  htmlSnippet   String?
  clickUrl      String
  width         Int
  height        Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  advertiser Advertiser @relation(fields: [advertiserId], references: [id])
  flights     AdFlight[]

  @@index([advertiserId, type])
}

model AdPlacement {
  id             String           @id @default(cuid())
  code           String           @unique
  name           String
  description    String?
  allowedTypes   AdCreativeType[] @default([])
  page           AdPlacementPage
  position       AdPlacementPosition
  allowDirect    Boolean          @default(true)
  allowAdSense   Boolean          @default(false)
  policyCompliant Boolean         @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  flights     AdFlight[]
  impressions AdImpression[]
  stats       AdStat[]

  @@index([page, position])
}

model AdCampaign {
  id                   String            @id @default(cuid())
  advertiserId         String
  name                 String
  startAt              DateTime
  endAt                DateTime?
  targetingJson        Json?
  cpmUsdCents          Int?
  cpcUsdCents          Int?
  dailyCapImpressions  Int?
  status               AdCampaignStatus @default(DRAFT)
  rewardPoolShareBps   Int?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  advertiser Advertiser  @relation(fields: [advertiserId], references: [id])
  flights     AdFlight[]
  stats       AdStat[]
  impressions AdImpression[]

  @@index([advertiserId, status])
  @@index([startAt, endAt])
}

model AdFlight {
  id           String   @id @default(cuid())
  campaignId   String
  creativeId   String
  placementId  String
  weight       Int      @default(1)
  priority     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  campaign  AdCampaign @relation(fields: [campaignId], references: [id])
  creative  AdCreative @relation(fields: [creativeId], references: [id])
  placement AdPlacement @relation(fields: [placementId], references: [id])
  stats     AdStat[]
  impressions AdImpression[]

  @@index([campaignId, priority])
  @@index([placementId])
}

model AdStat {
  id           String      @id @default(cuid())
  campaignId   String
  flightId     String
  placementId  String
  date         DateTime
  impressions  Int         @default(0)
  clicks       Int         @default(0)
  revenueMicros Int        @default(0)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  campaign  AdCampaign @relation(fields: [campaignId], references: [id])
  flight    AdFlight   @relation(fields: [flightId], references: [id])
  placement AdPlacement @relation(fields: [placementId], references: [id])

  @@unique([campaignId, flightId, placementId, date])
  @@index([date])
}

model AdImpression {
  id            String   @id @default(cuid())
  propertyId    String?
  userId        String?
  advertiserId  String?
  campaignId    String?
  flightId      String?
  placementId   String?
  route         String
  source        String?
  sessionId     String
  revenueMicros Int
  createdAt     DateTime @default(now())

  property   Property?     @relation(fields: [propertyId], references: [id])
  user       User?         @relation(fields: [userId], references: [id])
  advertiser Advertiser?   @relation(fields: [advertiserId], references: [id])
  campaign   AdCampaign?   @relation(fields: [campaignId], references: [id])
  flight     AdFlight?     @relation(fields: [flightId], references: [id])
  placement  AdPlacement?  @relation(fields: [placementId], references: [id])

  @@index([campaignId, placementId, createdAt])
}

model PromoBoost {
  id         String    @id @default(cuid())
  agentId    String
  propertyId String
  tier       PromoTier
  startAt    DateTime
  endAt      DateTime
  usdCents   Int

  agent    User     @relation(fields: [agentId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])

  @@index([propertyId, startAt, endAt])
}

model ShortLink {
  id          String   @id @default(cuid())
  code        String   @unique
  targetUrl   String
  propertyId  String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  clicks      Int      @default(0)
  createdAt   DateTime @default(now())

  property Property? @relation(fields: [propertyId], references: [id])
}

model PolicyStrike {
  id        String              @id @default(cuid())
  agentId   String
  reason    PolicyStrikeReason
  severity  Int
  resolved  Boolean  @default(false)
  createdAt DateTime @default(now())

  agent User @relation(fields: [agentId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  actorId    String?
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  actor User? @relation(fields: [actorId], references: [id])

  @@index([targetType, targetId])
  @@index([createdAt(sort: Desc)])
}

model FeatureFlag {
  key         String   @id
  description String?
  enabled     Boolean  @default(false)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}
