generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  VERIFIER
  AGENT
  LANDLORD
  USER
  MODERATOR
  COMPANY_ADMIN
  COMPANY_AGENT
  INDEPENDENT_AGENT
  SELLER
  TENANT
  BUYER
  ADVERTISER
}

enum PropertyType {
  ROOM
  COTTAGE
  HOUSE
  APARTMENT
  TOWNHOUSE
  PLOT
  LAND
  COMMERCIAL_OFFICE
  COMMERCIAL_RETAIL
  COMMERCIAL_INDUSTRIAL
  WAREHOUSE
  FARM
  MIXED_USE
  OTHER
}

enum PowerPhase {
  SINGLE
  THREE
}

enum PropertyAvailability {
  IMMEDIATE
  DATE
}

enum PropertyFurnishing {
  NONE
  PARTLY
  FULLY
}

enum Currency {
  USD
  ZWG
}

enum InvoicePurpose {
  DIRECT_AD
  PROMO_BOOST
  VERIFICATION
  RENT_PAYMENT
  BOOST
  OTHER
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
}

enum PaymentGateway {
  PAYNOW
  STRIPE
  PAYPAL
  OFFLINE
}

enum PaymentMethodType {
  CARD
  ECOCASH
  BANK
}

enum PaymentMethodStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  REVOKED
}

enum PaymentIntentStatus {
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
}

enum TransactionResult {
  SUCCESS
  FAILED
}

enum PropertyStatus {
  DRAFT
  PENDING_VERIFY
  VERIFIED
  UNDER_OFFER
  RENTED
  SOLD
  ARCHIVED
  OCCUPIED
  PUBLISHED
}

enum MediaKind {
  IMAGE
  VIDEO
}

enum VerificationMethod {
  AUTO
  CALL
  SITE
  DOCS
}

enum VerificationResult {
  PASS
  FAIL
}

enum LeadSource {
  WEB
  WHATSAPP
  FACEBOOK
  SHORTLINK
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  CLOSED
}

enum AgencyMemberRole {
  OWNER
  MANAGER
  AGENT
}

enum AgencyStatus {
  PENDING
  ACTIVE
  SUSPENDED
  PAUSED
  BANNED
}

enum ManagementContractScope {
  LETTING_ONLY
  FULL_MANAGEMENT
}

enum ManagementFeeType {
  FLAT
  PERCENT
}

enum ManagementContractStatus {
  DRAFT
  ACTIVE
  ENDED
  TERMINATED
}

enum GeoLevel {
  COUNTRY
  PROVINCE
  CITY
  SUBURB
}

enum PendingGeoStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RewardEventType {
  LISTING_VERIFIED
  LEAD_VALID
  SALE_CONFIRMED
  BONUS_TIER
  PROMO_REBATE
}

enum ListingEventType {
  RENTED
  SOLD
  REOPENED
  DISCOUNT
  UNDER_OFFER
}

enum ListingActivityType {
  OFFER_RECEIVED
  OFFER_ACCEPTED
  OFFER_REJECTED
  OFFER_CONFIRMED
  OFFER_ON_HOLD
  AGENT_ASSIGNED
  AGENT_UNASSIGNED
  PAYMENT_CREATED
  PAYMENT_PAID
  PAYMENT_FAILED
  VERIFICATION_SUBMITTED
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  VIEWING_SCHEDULED
  VIEWING_ACCEPTED
  VIEWING_POSTPONED
  VIEWING_CANCELLED
  CHAT_MESSAGE
  PROPERTY_VIEWED
  RATING_SUBMITTED
}

enum NotificationType {
  RENTED
  SOLD
  DISCOUNT
  REOPENED
  REWARD
  CHAT
  SYSTEM
  VERIFICATION_UPDATE
}

enum NotificationStatus {
  SENT
  READ
  FAILED
}

enum NotificationChannel {
  EMAIL
  PUSH
  WHATSAPP
  INAPP
}

enum NotificationLogStatus {
  OK
  FAIL
}

enum OwnerType {
  USER
  AGENCY
}

enum FeaturedListingStatus {
  ACTIVE
  EXPIRED
  PENDING_PAYMENT
}

enum ListingPaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

enum PayoutMethod {
  ECOCASH
  ONEMONEY
  BANK
  BANK_TRANSFER
  ZIPIT
  WALLET
  CASH
  OTHER
}

enum PayoutStatus {
  REQUESTED
  REVIEW
  APPROVED
  SENT
  PAID
  FAILED
  CANCELLED
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum KycIdType {
  NATIONAL_ID
  PASSPORT
  CERT_OF_INC
}

enum WalletTransactionType {
  CREDIT
  DEBIT
}

enum WalletTransactionSource {
  REWARD_EVENT
  PROMO_SHARE
  BONUS
  PAYOUT
  ADJUSTMENT
}

enum WalletLedgerType {
  CREDIT
  DEBIT
  HOLD
  RELEASE
  REFUND
}

enum WalletLedgerSourceType {
  VERIFICATION
  AGENT_COMMISSION
  COMMISSION_EARNED
  REFERRAL
  REWARD
  PAYOUT
  ADJUSTMENT
  AD_SPEND
}

enum PromoTier {
  LITE
  PLUS
  TOP
}

enum PolicyStrikeReason {
  VIEWING_FEE
  SCAM
  MISREPRESENTATION
}

enum AdvertiserStatus {
  ACTIVE
  PAUSED
  SUSPENDED
}

enum AdCreativeType {
  IMAGE
  HTML
  SCRIPT
}

enum AdPlacementPage {
  HOME
  SEARCH
  DETAIL
  ARTICLE
  GLOBAL
}

enum AdPlacementPosition {
  HEADER
  SIDEBAR
  INLINE
  FOOTER
  INTERSTITIAL
}

enum AdCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  ENDED
}

enum AdCampaignType {
  PROPERTY_BOOST
  BANNER
  SEARCH_SPONSOR
}

enum ReviewerType {
  PREVIOUS_TENANT
  NEIGHBOR
  EXTERNAL
  ANONYMOUS
}

enum ListingIntent {
  FOR_SALE
  TO_RENT
}

enum AdEventType {
  IMPRESSION
  CLICK
  HOVER
  CONVERSION
  VIDEO_START
  VIDEO_COMPLETE
}

enum AgentAssignmentStatus {
  PENDING
  ACCEPTED
  ACTIVE
  RESIGNED
}

model Country {
  id         String     @id @default(cuid())
  iso2       String     @unique
  name       String
  phoneCode  String
  provinces  Province[]
  cities     City[]
  suburbs    Suburb[]
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([name])
}

model Province {
  id         String     @id @default(cuid())
  countryId  String
  name       String
  country    Country    @relation(fields: [countryId], references: [id], onDelete: Cascade)
  cities     City[]
  suburbs    Suburb[]
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([countryId, name])
  @@index([countryId, name])
}

model City {
  id         String     @id @default(cuid())
  countryId  String
  provinceId String
  name       String
  lat        Float?
  lng        Float?
  country    Country    @relation(fields: [countryId], references: [id], onDelete: Cascade)
  province   Province   @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  suburbs    Suburb[]
  properties Property[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@unique([provinceId, name])
  @@index([countryId])
  @@index([lat, lng])
}

model Suburb {
  id             String     @id @default(cuid())
  countryId      String
  provinceId     String
  cityId         String
  name           String
  lat            Float?
  lng            Float?
  polygonGeoJson Json?
  country        Country    @relation(fields: [countryId], references: [id], onDelete: Cascade)
  province       Province   @relation(fields: [provinceId], references: [id], onDelete: Cascade)
  city           City       @relation(fields: [cityId], references: [id], onDelete: Cascade)
  properties     Property[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([cityId, name])
  @@index([countryId])
  @@index([provinceId])
  @@index([lat, lng])
}

model PendingGeo {
  id               String           @id @default(cuid())
  level            GeoLevel
  parentId         String?
  proposedName     String
  proposedByUserId String
  status           PendingGeoStatus @default(PENDING)
  mergedIntoId     String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  proposedBy       User             @relation(fields: [proposedByUserId], references: [id])
  properties       Property[]

  @@index([level, status])
  @@index([parentId])
}

model User {
  id           String   @id @default(cuid())
  role         Role     @default(USER)
  name         String?
  phone        String?
  email        String?  @unique
  passwordHash String?
  kycStatus    String?
  status       String?
  deletedAt    DateTime?
  mfaEnabled   Boolean  @default(false)
  mfaSecret    String?
  mfaTempSecret String?
  mfaRecoveryCodes String[] @default([])
  dateOfBirth  DateTime?
  idNumber     String?
  addressLine1 String?
  addressCity  String?
  addressProvince String?
  addressCountry String?
  trustTier    String   @default("NORMAL")
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())

  agentProfile                AgentProfile?
  landlordProfile             LandlordProfile?
  propertiesOwned             Property[]                @relation("AgentOwnerProperties")
  properties                  Property[]                @relation("LandlordProperties")
  leads                       Lead[]
  verifications               Verification[]            @relation("VerificationVerifier")
  verificationsRequested      Verification[]            @relation("VerificationRequester")
  verificationRequestsCreated VerificationRequest[]     @relation("VerificationRequestRequester")
  verificationItemsReviewed   VerificationRequestItem[] @relation("VerificationItemVerifier")
  rewardEvents                RewardEvent[]
  payouts                     Payout[]
  adImpressions               AdImpression[]
  promoBoosts                 PromoBoost[]
  policyStrikes               PolicyStrike[]
  agentAssignments            AgentAssignment[]         @relation("AgentAssignments")
  landlordAssignments         AgentAssignment[]         @relation("LandlordAgentAssignments")
  sentMessages                PropertyMessage[]         @relation("MessageSender")
  receivedMessages            PropertyMessage[]         @relation("MessageRecipient")
  dealConfirmations           Property[]                @relation("PropertyDealConfirmer")
  agencyMemberships           AgencyMember[]
  landlordContracts           ManagementContract[]      @relation("LandlordManagementContracts")
  pendingGeos                 PendingGeo[]
  priceHistoryChanges         PriceHistory[]            @relation("PriceHistoryChangedBy")
  discountOffersCreated       DiscountOffer[]           @relation("DiscountOfferCreatedBy")
  listingEventsCreated        ListingEvent[]            @relation("ListingEventCreatedBy")
  watchlistEntries            Watchlist[]
  notifications               Notification[]
  buyerInvoices               Invoice[]                 @relation("InvoiceBuyerUser")
  paymentMethodStatusLogs     PaymentMethodStatusLog[]  @relation("PaymentMethodStatusActor")
  auditLogs                   AuditLog[]                @relation("AuditLogActor")
  ownedAdvertisers            Advertiser[]              @relation("AdvertiserOwner")

  // New relations
  interestsCreated         Interest[]           @relation("UserInterests")
  reviewsReceived          UserReview[]         @relation("Reviewee")
  reviewsGiven             UserReview[]         @relation("Reviewer")
  propertyRatingsGiven     PropertyRating[]     @relation("PropertyRatingReviewer")
  agencyReviewsGiven       AgencyReview[]
  listingActivitiesCreated ListingActivityLog[] @relation("ListingActivityActor")
  rentPayments             RentPayment[]        @relation("TenantRentPayments")
  viewingsAsViewer         Viewing[]            @relation("ViewingViewer")
  viewingsAsAgent          Viewing[]            @relation("ViewingAgent")
  viewingsAsLandlord       Viewing[]            @relation("ViewingLandlord")

  // New Profile Fields
  profilePhoto      String?
  bio               String?
  location          String?
  trustScore        Int     @default(0)
  verificationScore Int     @default(0)
  riskScore         Int     @default(0) // Internal only

  // Role Management
  roles         UserRole[]
  rolesAssigned UserRole[] @relation("RoleAssigner")

  agencyMembersAssigned AgencyMember[] @relation("AgencyMemberAssigner")

  // Site Visit Relations
  siteVisitsRequested SiteVisit[] @relation("SiteVisitRequester")
  siteVisitsAssigned  SiteVisit[] @relation("SiteVisitModerator")

  // Payment Relations
  paymentProfile      UserPaymentProfile?  @relation("UserPaymentProfile")
  paymentTransactions PaymentTransaction[] @relation("PaymentTransactionUser")
  referralEarnings    ReferralEarning[]    @relation("ReferralEarningReferrer")
  walletLedgerEntries WalletLedger[]       @relation("WalletLedgerUser")
  adEvents            AdEvent[]            @relation("AdEventUser")
  rewardDistributions RewardDistribution[]
  adClicks            AdClick[]            @relation("AdClickUser")

  // Application, Deal, Conversation, and Message Relations
  applications             Application[]             @relation("UserApplications")
  tenantDeals              Deal[]                    @relation("TenantDeals")
  landlordDeals            Deal[]                    @relation("LandlordDeals")
  agentDeals               Deal[]                    @relation("AgentDeals")
  commissions              Commission[]              @relation("UserCommissions")
  conversationParticipants ConversationParticipant[] @relation("ConversationParticipants")
  sentConversationMessages Message[]                 @relation("UserMessages")
}

model UserRole {
  id           String    @id @default(cuid())
  userId       String
  role         Role
  assignedById String?
  assignedAt   DateTime  @default(now())
  revokedAt    DateTime?

  user       User  @relation(fields: [userId], references: [id])
  assignedBy User? @relation("RoleAssigner", fields: [assignedById], references: [id])

  @@index([userId])
  @@index([role])
}

model Payout {
  id        String   @id @default(cuid())
  userId    String
  amount    Decimal  @db.Decimal(18, 2)
  status    String   @default("pending")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AgentProfile {
  userId                String  @id
  bio                   String?
  rating                Float   @default(0)
  verifiedListingsCount Int     @default(0)
  leadsCount            Int     @default(0)
  strikesCount          Int     @default(0)
  kycStatus             String?

  user User @relation(fields: [userId], references: [id])
}

model LandlordProfile {
  userId      String    @id
  companyName String?
  verifiedAt  DateTime?

  user User @relation(fields: [userId], references: [id])
}

model Agency {
  id        String  @id @default(cuid())
  name      String
  licenseNo String?
  email     String?
  phone     String?
  address   String?
  logoUrl   String?
  kycStatus String?

  slug String? @unique

  // Company Profile Fields
  registrationNumber String?
  directorsJson      Json?
  bio                String?
  shortDescription   String?
  description        String?
  servicesOffered    String?
  trustScore         Int       @default(0)
  verificationScore  Int       @default(0)
  riskScore          Int       @default(0) // Internal only
  verifiedAt         DateTime?

  status    AgencyStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  members       AgencyMember[]
  contracts     ManagementContract[]
  properties    Property[]
  buyerInvoices Invoice[]            @relation("InvoiceBuyerAgency")
  reviews       AgencyReview[]

  @@index([status])
  @@index([name])
}

model AgencyMember {
  id       String           @id @default(cuid())
  agencyId String
  userId   String
  role     AgencyMemberRole
  joinedAt DateTime         @default(now())
  isActive Boolean          @default(true)

  revokedAt    DateTime?
  assignedById String?

  agency     Agency @relation(fields: [agencyId], references: [id])
  user       User   @relation(fields: [userId], references: [id])
  assignedBy User?  @relation("AgencyMemberAssigner", fields: [assignedById], references: [id])

  @@unique([agencyId, userId])
  @@index([userId, role])
}

model ManagementContract {
  id         String                   @id @default(cuid())
  agencyId   String
  landlordId String
  startAt    DateTime
  endAt      DateTime?
  scope      ManagementContractScope
  feeType    ManagementFeeType
  feeValue   Decimal                  @db.Decimal(12, 2)
  notes      String?
  status     ManagementContractStatus @default(DRAFT)
  createdAt  DateTime                 @default(now())
  updatedAt  DateTime                 @updatedAt

  agency   Agency @relation(fields: [agencyId], references: [id])
  landlord User   @relation("LandlordManagementContracts", fields: [landlordId], references: [id])

  @@index([agencyId, status])
  @@index([landlordId])
}

model Property {
  id                String               @id @default(cuid())
  landlordId        String?
  agentOwnerId      String?
  agencyId          String?
  countryId         String?
  provinceId        String?
  cityId            String?
  suburbId          String?
  pendingGeoId      String?
  title             String
  lat               Float?
  lng               Float?
  type              PropertyType
  listingIntent     ListingIntent?
  currency          Currency
  price             Decimal              @db.Decimal(12, 2)
  bedrooms          Int?
  bathrooms         Int?
  areaSqm           Float?
  amenities         String[]             @default([])
  furnishing        PropertyFurnishing   @default(NONE)
  availability      PropertyAvailability @default(IMMEDIATE)
  availableFrom     DateTime?
  commercialFields  Json?
  description       String?
  status            PropertyStatus       @default(DRAFT)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  verifiedAt        DateTime?
  dealConfirmedAt   DateTime?
  dealConfirmedById String?
  isManaged         Boolean              @default(false)

  landlord        User?                @relation("LandlordProperties", fields: [landlordId], references: [id])
  agentOwner      User?                @relation("AgentOwnerProperties", fields: [agentOwnerId], references: [id])
  agency          Agency?              @relation(fields: [agencyId], references: [id])
  country         Country?             @relation(fields: [countryId], references: [id])
  province        Province?            @relation(fields: [provinceId], references: [id])
  city            City?                @relation(fields: [cityId], references: [id])
  suburb          Suburb?              @relation(fields: [suburbId], references: [id])
  pendingGeo      PendingGeo?          @relation(fields: [pendingGeoId], references: [id])
  dealConfirmedBy User?                @relation("PropertyDealConfirmer", fields: [dealConfirmedById], references: [id])
  media           PropertyMedia[]
  verifications   Verification[]
  leads           Lead[]
  adImpressions   AdImpression[]
  promoBoosts     PromoBoost[]
  assignments     AgentAssignment[]
  messages        PropertyMessage[]
  priceHistory    PriceHistory[]
  discountOffers  DiscountOffer[]
  listingEvents   ListingEvent[]
  watchlists      Watchlist[]
  metricsDaily    MetricListingDaily[]
  shortLinks      ShortLink[]
  reviews         UserReview[]

  // Role-Aware
  createdByRole String @default("LANDLORD")

  // Verification Signals
  verificationScore Int               @default(0)
  verificationLevel VerificationLevel @default(NONE)
  trustScore        Int               @default(0)
  riskScore         Int               @default(0) // Internal only

  // New relations
  interests            Interest[]
  rentPayments         RentPayment[]
  viewings             Viewing[]
  featuredListing      FeaturedListing?
  listingPayments      ListingPayment[]
  verificationRequests VerificationRequest[]
  propertyRatings      PropertyRating[]
  activityLogs         ListingActivityLog[]
  siteVisits           SiteVisit[]
  campaignTargets      AdCampaign[]          @relation("CampaignTargetProperty")
  adClicks             AdClick[]

  // Application, Deal, and Conversation Relations
  applications  Application[]
  deals         Deal[]
  conversations Conversation[]
  commissions   Commission[]

  @@index([status])
  @@index([countryId])
  @@index([provinceId])
  @@index([cityId])
  @@index([suburbId])
  @@index([lat, lng])
  @@index([price])
  @@index([verifiedAt])
  @@index([dealConfirmedAt])
  @@index([createdAt(sort: Desc)])
  @@index([agencyId])
  @@index([isManaged])
  @@index([status, cityId, suburbId, type, verifiedAt, updatedAt], map: "property_status_city_suburb_type_verified_updated")
}

model AgentAssignment {
  id                 String                  @id @default(cuid())
  propertyId         String
  landlordId         String
  agentId            String
  serviceFeeUsdCents Int?
  landlordPaysFee    Boolean                 @default(true)
  status             AgentAssignmentStatus   @default(PENDING)
  acceptedAt         DateTime?
  createdAt          DateTime                @default(now())
  deletedAt          DateTime?

  property Property @relation(fields: [propertyId], references: [id])
  landlord User     @relation("LandlordAgentAssignments", fields: [landlordId], references: [id])
  agent    User     @relation("AgentAssignments", fields: [agentId], references: [id])

  @@index([propertyId, createdAt(sort: Desc)])
  @@index([agentId, status])
}

model PropertyMessage {
  id          String    @id @default(cuid())
  propertyId  String
  senderId    String
  recipientId String
  body        String
  createdAt   DateTime  @default(now())
  readAt      DateTime?

  property  Property @relation(fields: [propertyId], references: [id])
  sender    User     @relation("MessageSender", fields: [senderId], references: [id])
  recipient User     @relation("MessageRecipient", fields: [recipientId], references: [id])

  @@index([propertyId, createdAt])
  @@index([recipientId, readAt])
}

model PriceHistory {
  id            String   @id @default(cuid())
  propertyId    String
  previousPrice Decimal  @db.Decimal(12, 2)
  newPrice      Decimal  @db.Decimal(12, 2)
  currency      Currency
  changedById   String
  changedAt     DateTime @default(now())

  property  Property @relation(fields: [propertyId], references: [id])
  changedBy User     @relation("PriceHistoryChangedBy", fields: [changedById], references: [id])

  @@index([propertyId, changedAt(sort: Desc)], map: "price_history_property_id_changed_at_desc")
}

model DiscountOffer {
  id          String    @id @default(cuid())
  propertyId  String
  percentOff  Decimal?  @db.Decimal(5, 2)
  amountOff   Decimal?  @db.Decimal(12, 2)
  startAt     DateTime?
  endAt       DateTime?
  reason      String?
  createdById String
  createdAt   DateTime  @default(now())

  property  Property @relation(fields: [propertyId], references: [id])
  createdBy User     @relation("DiscountOfferCreatedBy", fields: [createdById], references: [id])

  @@index([propertyId, startAt, endAt], map: "discount_offer_property_time")
}

model ListingEvent {
  id          String           @id @default(cuid())
  propertyId  String
  type        ListingEventType
  createdById String
  createdAt   DateTime         @default(now())
  metaJson    Json?

  property  Property @relation(fields: [propertyId], references: [id])
  createdBy User     @relation("ListingEventCreatedBy", fields: [createdById], references: [id])

  @@index([propertyId, createdAt(sort: Desc)], map: "listing_event_property_id_created_at_desc")
}

model Watchlist {
  userId     String
  propertyId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@id([userId, propertyId])
  @@index([userId, propertyId], map: "watchlist_user_id_property_id")
}

model Notification {
  id        String             @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  url       String?
  status    NotificationStatus @default(SENT)
  createdAt DateTime           @default(now())
  readAt    DateTime?

  user User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs NotificationLog[]

  @@index([userId, createdAt(sort: Desc)])
}

model NotificationLog {
  id             String                @id @default(cuid())
  notificationId String
  channel        NotificationChannel
  providerId     String?
  status         NotificationLogStatus
  payloadJson    Json?
  createdAt      DateTime              @default(now())

  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId, channel, createdAt])
}

model MetricListingDaily {
  listingId      String
  day            DateTime
  impressions    Int      @default(0)
  clicks         Int      @default(0)
  sessions       Int      @default(0)
  saves          Int      @default(0)
  qualifiedLeads Int      @default(0)
  dwellSeconds   Int      @default(0)

  property Property @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@id([listingId, day])
  @@index([listingId, day], map: "metric_listing_daily_listing_id_day")
}

model AppConfig {
  key       String   @id
  jsonValue Json
  updatedAt DateTime @updatedAt
}

model PropertyMedia {
  id         String    @id @default(cuid())
  propertyId String
  url        String
  kind       MediaKind
  order      Int       @default(0)
  exifJson   Json?
  hasGps     Boolean
  shotAt     DateTime?
  createdAt  DateTime  @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId, order])
}

enum VerificationItemType {
  PROOF_OF_OWNERSHIP
  LOCATION_CONFIRMATION
  PROPERTY_PHOTOS
  COMPANY_REGS
  IDENTITY_DOC
  PROOF_OF_ADDRESS
  SELFIE_VERIFICATION
  TAX_CLEARANCE
  DIRECTOR_ID
  BUSINESS_ADDRESS
}

enum VerificationLevel {
  NONE
  BASIC
  TRUSTED
  VERIFIED
}

model Verification {
  id          String              @id @default(cuid())
  propertyId  String? // Optional now as we have polymorphic targetId
  verifierId  String?
  requesterId String?
  method      VerificationMethod  @default(DOCS)
  result      VerificationResult?
  status      String              @default("PENDING")
  notes       String?
  evidenceUrl String?
  createdAt   DateTime            @default(now())

  property  Property? @relation(fields: [propertyId], references: [id])
  verifier  User?     @relation("VerificationVerifier", fields: [verifierId], references: [id])
  requester User?     @relation("VerificationRequester", fields: [requesterId], references: [id])

  // Polymorphic fields
  targetType String @default("property") // property, user, agent, landlord
  targetId   String @default("")
}

model VerificationRequest {
  id           String  @id @default(cuid())
  propertyId   String?
  agencyId     String?
  targetUserId String?

  // Polymorphic Target
  targetType VerificationType @default(PROPERTY)
  targetId   String           @default("") // indexed for admin filtering

  requesterId String
  status      String   @default("PENDING")
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property  Property?                 @relation(fields: [propertyId], references: [id])
  requester User                      @relation("VerificationRequestRequester", fields: [requesterId], references: [id])
  items     VerificationRequestItem[]

  @@index([propertyId])
  @@index([requesterId])
  @@index([status])
  @@index([targetType, targetId]) // Generic lookup
}

enum VerificationType {
  PROPERTY
  USER
  COMPANY
}

model VerificationRequestItem {
  id                    String               @id @default(cuid())
  verificationRequestId String
  type                  VerificationItemType
  status                String               @default("PENDING")
  evidenceUrls          String[]             @default([]) // Array of uploaded file URLs
  gpsLat                Float? // For location confirmation
  gpsLng                Float? // For location confirmation
  notes                 String? // User notes or verifier feedback
  verifierId            String? // Admin/verifier who reviewed
  reviewedAt            DateTime?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  verificationRequest VerificationRequest    @relation(fields: [verificationRequestId], references: [id], onDelete: Cascade)
  verifier            User?                  @relation("VerificationItemVerifier", fields: [verifierId], references: [id])
  evidence            VerificationEvidence[]
  siteVisits          SiteVisit[]

  @@index([verificationRequestId])
  @@index([type, status])
}

model VerificationEvidence {
  id        String   @id @default(cuid())
  itemId    String
  url       String
  fileHash  String?
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())

  item VerificationRequestItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([fileHash])
  @@index([itemId])
}

model UserReview {
  id         String       @id @default(cuid())
  reviewerId String
  revieweeId String
  propertyId String?
  rating     Int
  weight     Int          @default(1)
  comment    String?
  type       ReviewerType @default(EXTERNAL)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  reviewer User      @relation("Reviewer", fields: [reviewerId], references: [id])
  reviewee User      @relation("Reviewee", fields: [revieweeId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])

  @@index([revieweeId])
  @@index([reviewerId])
  @@index([propertyId])
}

model PropertyRating {
  id               String   @id @default(cuid())
  propertyId       String
  reviewerId       String? // Null if anonymous
  rating           Int // 1-5 stars
  weight           Int      @default(1) // Calculated weight
  comment          String?
  type             String
  isAnonymous      Boolean  @default(false) // For current tenants
  tenantMonths     Int? // Length of tenancy in months (for weight calculation)
  isVerifiedTenant Boolean  @default(false) // Verified tenant status
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  reviewer User?    @relation("PropertyRatingReviewer", fields: [reviewerId], references: [id])

  @@unique([propertyId, reviewerId]) // One rating per user per property (unless anonymous)
  @@index([propertyId, createdAt(sort: Desc)])
  @@index([reviewerId])
  @@index([type, weight])
}

model ListingActivityLog {
  id         String              @id @default(cuid())
  propertyId String
  type       ListingActivityType
  actorId    String? // User who performed the action
  metadata   Json? // Additional context (offer amount, agent name, etc.)
  createdAt  DateTime            @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  actor    User?    @relation("ListingActivityActor", fields: [actorId], references: [id])

  @@index([propertyId, createdAt(sort: Desc)])
  @@index([type, createdAt(sort: Desc)])
}

model Viewing {
  id          String   @id @default(cuid())
  propertyId  String
  viewerId    String
  agentId     String? // If assigned agent is handling
  landlordId  String? // If landlord is handling
  scheduledAt DateTime
  status      String   @default("PENDING")
  notes       String?
  locationLat Float?
  locationLng Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  viewer   User     @relation("ViewingViewer", fields: [viewerId], references: [id])
  agent    User?    @relation("ViewingAgent", fields: [agentId], references: [id])
  landlord User?    @relation("ViewingLandlord", fields: [landlordId], references: [id])

  @@index([propertyId, scheduledAt])
  @@index([viewerId])
  @@index([agentId])
}

model FeaturedListing {
  id            String                @id @default(cuid())
  listingId     String                @unique
  startsAt      DateTime
  endsAt        DateTime
  paymentId     String?
  priorityLevel Int                   @default(1)
  status        FeaturedListingStatus @default(ACTIVE)
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  property Property @relation(fields: [listingId], references: [id])
}

model Lead {
  id           String     @id @default(cuid())
  propertyId   String
  userId       String?
  source       LeadSource
  channelRef   String?
  contactPhone String
  status       LeadStatus @default(NEW)
  createdAt    DateTime   @default(now())

  property Property @relation(fields: [propertyId], references: [id])
  user     User?    @relation(fields: [userId], references: [id])

  @@index([propertyId, source])
  @@index([createdAt(sort: Desc)])
}

model RewardEvent {
  id        String          @id @default(cuid())
  agentId   String
  type      RewardEventType
  points    Int
  usdCents  Int
  refId     String?
  createdAt DateTime        @default(now())

  agent User @relation(fields: [agentId], references: [id])

  @@index([agentId, createdAt(sort: Desc)])
}

model Wallet {
  id           String    @id @default(cuid())
  ownerType    OwnerType
  ownerId      String
  currency     Currency
  balanceCents Int       @default(0) // DEPRECATED: Use WalletLedger for balance calculation
  pendingCents Int       @default(0) // DEPRECATED: Use WalletLedger for balance calculation
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  transactions   WalletTransaction[]
  payoutRequests PayoutRequest[]
  payoutAccounts PayoutAccount[]
  ledgerEntries  WalletLedger[]

  @@unique([ownerType, ownerId, currency])
}

model WalletLedger {
  id          String                 @id @default(cuid())
  userId      String
  type        WalletLedgerType
  sourceType  WalletLedgerSourceType
  sourceId    String? // Reference to source entity (PaymentTransaction, PayoutRequest, etc.)
  amountCents Int
  currency    Currency
  metadata    Json?
  createdAt   DateTime               @default(now())

  user                 User                @relation("WalletLedgerUser", fields: [userId], references: [id], onDelete: Cascade)
  wallet               Wallet?             @relation(fields: [walletId], references: [id])
  walletId             String?
  rewardDistribution   RewardDistribution? @relation(fields: [rewardDistributionId], references: [id])
  rewardDistributionId String?

  @@index([userId, createdAt(sort: Desc)])
  @@index([userId, type])
  @@index([sourceType, sourceId])
  @@index([createdAt])
}

model WalletTransaction {
  id               String                  @id @default(cuid())
  walletId         String
  amountCents      Int
  type             WalletTransactionType
  source           WalletTransactionSource
  sourceId         String?
  description      String?
  availableAt      DateTime?               @default(now())
  appliedToBalance Boolean                 @default(false)
  createdAt        DateTime                @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id])

  @@index([walletId, createdAt(sort: Desc)])
  @@index([walletId, availableAt])
}

model PayoutAccount {
  id          String       @id @default(cuid())
  ownerType   OwnerType
  ownerId     String
  walletId    String?
  type        PayoutMethod
  displayName String
  detailsJson Json
  verifiedAt  DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  wallet         Wallet?         @relation(fields: [walletId], references: [id])
  payoutRequests PayoutRequest[]

  @@index([ownerType, ownerId])
  @@index([walletId])
}

model KycRecord {
  id        String    @id @default(cuid())
  ownerType OwnerType
  ownerId   String
  idType    KycIdType
  idNumber  String
  docUrls   String[]
  docTypes  String[]  @default([])
  idExpiryDate DateTime?
  status    KycStatus @default(PENDING)
  notes     String?
  updatedAt DateTime  @updatedAt
  createdAt DateTime  @default(now())

  @@index([ownerType, ownerId, status])
}

model PayoutRequest {
  id              String       @id @default(cuid())
  walletId        String
  amountCents     Int
  method          PayoutMethod
  payoutAccountId String
  status          PayoutStatus @default(REQUESTED)
  scheduledFor    DateTime?
  txRef           String?
  receiptPdfUrl   String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  wallet             Wallet              @relation(fields: [walletId], references: [id])
  payoutAccount      PayoutAccount       @relation(fields: [payoutAccountId], references: [id])
  payoutTransactions PayoutTransaction[] @relation("PayoutTransactionRequest")
  referralEarnings   ReferralEarning[]   @relation("ReferralEarningPayout")

  @@index([walletId, status, createdAt(sort: Desc)])
  @@index([txRef])
}

model Advertiser {
  id           String           @id @default(cuid())
  name         String
  contactEmail String?
  phone        String?
  companyName  String? // Optional company name
  billingInfo  Json?
  balanceCents Int              @default(0) // Ad spend balance
  status       AdvertiserStatus @default(ACTIVE)
  ownerId      String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  owner       User?        @relation("AdvertiserOwner", fields: [ownerId], references: [id])

  campaigns   AdCampaign[]
  creatives   AdCreative[]
  impressions AdImpression[]
  balanceLogs AdvertiserBalanceLog[]
  invoices    Invoice[]
  fraudEvents FraudEvent[]

  @@index([status])
}

model AdCreative {
  id           String         @id @default(cuid())
  advertiserId String
  type         AdCreativeType
  assetUrl     String?
  htmlSnippet  String?
  clickUrl     String
  width        Int
  height       Int
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  advertiser Advertiser @relation(fields: [advertiserId], references: [id])
  flights    AdFlight[]
  AdEvent    AdEvent[]

  @@index([advertiserId, type])
}

model AdPlacement {
  id              String              @id @default(cuid())
  code            String              @unique
  name            String
  description     String?
  allowedTypes    AdCreativeType[]    @default([])
  page            AdPlacementPage
  position        AdPlacementPosition
  allowDirect     Boolean             @default(true)
  allowAdSense    Boolean             @default(false)
  policyCompliant Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  flights     AdFlight[]
  impressions AdImpression[]
  stats       AdStat[]
  AdEvent     AdEvent[]

  @@index([page, position])
}

model AdCampaign {
  id                  String           @id @default(cuid())
  advertiserId        String
  invoiceId           String?          @unique
  name                String
  type                AdCampaignType? // Campaign type
  targetPropertyId    String? // For PROPERTY_BOOST campaigns
  budgetCents         Int? // Total budget limit
  spentCents          Int              @default(0) // Track spent amount
  dailyCapCents       Int? // Daily spending limit
  startAt             DateTime
  endAt               DateTime?
  targetingJson       Json?
  cpmUsdCents         Int?
  cpcUsdCents         Int?
  dailyCapImpressions Int?
  status              AdCampaignStatus @default(DRAFT)
  rewardPoolShareBps  Int?
  rewardPoolId        String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  advertiser     Advertiser     @relation(fields: [advertiserId], references: [id])
  invoice        Invoice?       @relation("AdCampaignInvoice", fields: [invoiceId], references: [id])
  rewardPool     RewardPool?    @relation(fields: [rewardPoolId], references: [id])
  targetProperty Property?      @relation("CampaignTargetProperty", fields: [targetPropertyId], references: [id])
  flights        AdFlight[]
  stats          AdStat[]
  impressions    AdImpression[]
  adEvents       AdEvent[]
  adClicks       AdClick[]
  fraudEvents    FraudEvent[]

  @@index([advertiserId, status])
  @@index([startAt, endAt])
  @@index([type, status])
  @@index([targetPropertyId])
}

model AdFlight {
  id          String   @id @default(cuid())
  campaignId  String
  creativeId  String
  placementId String
  weight      Int      @default(1)
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  campaign    AdCampaign     @relation(fields: [campaignId], references: [id])
  creative    AdCreative     @relation(fields: [creativeId], references: [id])
  placement   AdPlacement    @relation(fields: [placementId], references: [id])
  stats       AdStat[]
  impressions AdImpression[]
  AdEvent     AdEvent[]

  @@index([campaignId, priority])
  @@index([placementId])
}

model AdStat {
  id            String   @id @default(cuid())
  campaignId    String
  flightId      String
  placementId   String
  date          DateTime
  impressions   Int      @default(0)
  clicks        Int      @default(0)
  revenueMicros Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  campaign  AdCampaign  @relation(fields: [campaignId], references: [id])
  flight    AdFlight    @relation(fields: [flightId], references: [id])
  placement AdPlacement @relation(fields: [placementId], references: [id])

  @@unique([campaignId, flightId, placementId, date])
  @@index([date])
}

model AdImpression {
  id            String   @id @default(cuid())
  propertyId    String?
  userId        String?
  advertiserId  String?
  campaignId    String?
  flightId      String?
  placementId   String?
  route         String
  source        String?
  sessionId     String
  ipAddress     String? // [Fraud]
  userAgent     String? // [Fraud]
  countryCode   String? // [Fraud]
  fingerprint   String? // [Fraud]
  revenueMicros Int
  createdAt     DateTime @default(now())

  property   Property?    @relation(fields: [propertyId], references: [id])
  user       User?        @relation(fields: [userId], references: [id])
  advertiser Advertiser?  @relation(fields: [advertiserId], references: [id])
  campaign   AdCampaign?  @relation(fields: [campaignId], references: [id])
  flight     AdFlight?    @relation(fields: [flightId], references: [id])
  placement  AdPlacement? @relation(fields: [placementId], references: [id])

  @@index([campaignId, placementId, createdAt])
}

model MetricDailyAds {
  date          DateTime @id
  impressions   Int
  clicks        Int
  revenueMicros BigInt
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([date(sort: Desc)])
}

model MetricDailyRevenue {
  date            DateTime @id
  grossUsdCents   BigInt
  payoutsUsdCents BigInt
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([date(sort: Desc)])
}

model MetricDailyTraffic {
  date           DateTime @id
  visits         Int
  uniqueSessions Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([date(sort: Desc)])
}

model PromoBoost {
  id         String    @id @default(cuid())
  agentId    String
  propertyId String
  invoiceId  String?   @unique
  tier       PromoTier
  startAt    DateTime
  endAt      DateTime
  usdCents   Int

  agent    User     @relation(fields: [agentId], references: [id])
  property Property @relation(fields: [propertyId], references: [id])
  invoice  Invoice? @relation("PromoBoostInvoice", fields: [invoiceId], references: [id])

  @@index([propertyId, startAt, endAt])
}

model Invoice {
  id             String         @id @default(cuid())
  buyerUserId    String?
  buyerAgencyId  String?
  advertiserId   String?
  purpose        InvoicePurpose
  currency       Currency
  amountCents    Int
  taxCents       Int
  amountUsdCents Int
  taxUsdCents    Int
  status         InvoiceStatus  @default(DRAFT)
  dueAt          DateTime?
  issuedAt       DateTime?
  invoiceNo      String?        @unique
  pdfUrl         String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  fxRateId       String?

  buyerUser           User?                @relation("InvoiceBuyerUser", fields: [buyerUserId], references: [id])
  buyerAgency         Agency?              @relation("InvoiceBuyerAgency", fields: [buyerAgencyId], references: [id])
  advertiser          Advertiser?          @relation(fields: [advertiserId], references: [id])
  lines               InvoiceLine[]
  paymentIntents      PaymentIntent[]
  transactions        Transaction[]
  campaign            AdCampaign?          @relation("AdCampaignInvoice")
  promoBoost          PromoBoost?          @relation("PromoBoostInvoice")
  boost               Boost?               @relation("BoostInvoice")
  fxRate              FxRate?              @relation(fields: [fxRateId], references: [id])
  listingPayments     ListingPayment[]     @relation("ListingPaymentInvoice")
  paymentTransactions PaymentTransaction[] @relation("PaymentTransactionInvoice")

  @@index([status, dueAt])
}

model RewardPool {
  id            String   @id @default(cuid())
  name          String
  description   String?
  totalUsdCents Int      @default(0)
  spentUsdCents Int      @default(0)
  currency      Currency @default(USD)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  distributions RewardDistribution[]
  campaigns     AdCampaign[]
}

model RewardDistribution {
  id          String    @id @default(cuid())
  poolId      String
  userId      String
  amountCents Int
  currency    Currency
  reason      String?
  status      String    @default("PENDING")
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  pool          RewardPool     @relation(fields: [poolId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
  ledgerEntries WalletLedger[]
}

model AdEvent {
  id          String      @id @default(cuid())
  campaignId  String
  flightId    String
  placementId String
  creativeId  String
  userId      String?
  type        AdEventType
  metadata    Json?
  userAgent   String?
  ipAddress   String?
  sessionId   String?
  createdAt   DateTime    @default(now())

  campaign  AdCampaign  @relation(fields: [campaignId], references: [id])
  flight    AdFlight    @relation(fields: [flightId], references: [id])
  placement AdPlacement @relation(fields: [placementId], references: [id])
  creative  AdCreative  @relation(fields: [creativeId], references: [id])
  user      User?       @relation("AdEventUser", fields: [userId], references: [id])

  @@index([campaignId, type, createdAt])
  @@index([userId, type])
  @@index([sessionId])
}

model InvoiceLine {
  id             String @id @default(cuid())
  invoiceId      String
  sku            String
  description    String
  qty            Int
  unitPriceCents Int
  totalCents     Int
  metaJson       Json?

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model PaymentIntent {
  id          String              @id @default(cuid())
  invoiceId   String
  gateway     PaymentGateway
  reference   String              @unique
  amountCents Int
  currency    Currency
  status      PaymentIntentStatus @default(REQUIRES_ACTION)
  redirectUrl String?
  gatewayRef  String?
  createdAt   DateTime            @default(now())

  invoice             Invoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paymentTransactions PaymentTransaction[] @relation("PaymentTransactionIntent")

  @@index([invoiceId, gateway, status])
}

model FxRate {
  id         String   @id @default(cuid())
  base       Currency
  quote      Currency
  rateMicros Int
  date       DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  invoices Invoice[]

  @@unique([base, quote, date])
}

model Transaction {
  id             String            @id @default(cuid())
  invoiceId      String
  gateway        PaymentGateway
  externalRef    String
  amountCents    Int
  currency       Currency
  feeCents       Int               @default(0)
  netCents       Int
  result         TransactionResult
  rawWebhookJson Json?
  receiptPdfUrl  String?
  createdAt      DateTime          @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([gateway, externalRef])
}

model PaymentMethod {
  id                      String              @id @default(cuid())
  ownerType               OwnerType
  ownerId                 String
  type                    PaymentMethodType
  gatewayRef              String?
  brand                   String?
  last4                   String?
  expMonth                Int?
  expYear                 Int?
  isDefault               Boolean             @default(false)
  status                  PaymentMethodStatus @default(ACTIVE)
  recurringConsentAt      DateTime?
  recurringConsentActorId String?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  statusLogs PaymentMethodStatusLog[]

  @@index([ownerType, ownerId])
  @@index([ownerType, ownerId, isDefault])
}

model PaymentMethodStatusLog {
  id              String               @id @default(cuid())
  paymentMethodId String
  fromStatus      PaymentMethodStatus?
  toStatus        PaymentMethodStatus
  reason          String?
  actorId         String?
  createdAt       DateTime             @default(now())

  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  actor         User?         @relation("PaymentMethodStatusActor", fields: [actorId], references: [id])

  @@index([paymentMethodId, createdAt(sort: Desc)])
}

model ShortLink {
  id          String   @id @default(cuid())
  code        String   @unique
  targetUrl   String
  propertyId  String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  utmTerm     String?
  utmContent  String?
  clicks      Int      @default(0)
  createdAt   DateTime @default(now())

  property Property? @relation(fields: [propertyId], references: [id])
}

model PolicyStrike {
  id        String             @id @default(cuid())
  agentId   String
  reason    PolicyStrikeReason
  severity  Int
  resolved  Boolean            @default(false)
  createdAt DateTime           @default(now())

  agent User @relation(fields: [agentId], references: [id])
}

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  actorId    String?
  targetType String
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  actor User? @relation("AuditLogActor", fields: [actorId], references: [id])

  @@index([targetType, targetId])
  @@index([createdAt(sort: Desc)])
}

model FeatureFlag {
  key         String   @id
  description String?
  enabled     Boolean  @default(false)
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
}

// New Models

model AgencyReview {
  id         String   @id @default(cuid())
  agencyId   String
  reviewerId String
  rating     Int
  weight     Int      @default(1)
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  agency   Agency @relation(fields: [agencyId], references: [id])
  reviewer User   @relation(fields: [reviewerId], references: [id])

  @@index([agencyId])
  @@index([reviewerId])
}

model Interest {
  id String @id @default(cuid())

  propertyId  String
  userId      String
  status      String   @default("PENDING")
  offerAmount Decimal? @db.Decimal(12, 2)
  message     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  user     User     @relation("UserInterests", fields: [userId], references: [id])

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
}

model RentPayment {
  id         String   @id @default(cuid())
  propertyId String
  tenantId   String
  amount     Decimal  @db.Decimal(12, 2)
  currency   Currency
  paidAt     DateTime
  proofUrl   String?
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id])
  tenant   User     @relation("TenantRentPayments", fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([propertyId])
}

model ListingPayment {
  id          String               @id @default(cuid())
  propertyId  String
  type        String
  amountCents Int
  currency    Currency
  status      ListingPaymentStatus @default(PENDING)
  reference   String? // Payment reference or invoice number
  invoiceId   String? // Link to Invoice if applicable
  metadata    Json? // Additional context (e.g., agent assignment ID, featured listing ID)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  invoice  Invoice? @relation("ListingPaymentInvoice", fields: [invoiceId], references: [id])

  @@index([propertyId, createdAt(sort: Desc)])
  @@index([status])
  @@index([type])
}

model SiteVisit {
  id                  String  @id @default(cuid())
  propertyId          String
  verificationItemId  String? // Optional link to specific item
  requestedByUserId   String
  assignedModeratorId String?

  status String @default("PENDING_ASSIGNMENT")

  scheduledAt              DateTime?
  visitGpsLat              Float?
  visitGpsLng              Float?
  distanceFromSubmittedGps Float? // Computed in km

  notes       String?
  completedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  property          Property                 @relation(fields: [propertyId], references: [id])
  requestedBy       User                     @relation("SiteVisitRequester", fields: [requestedByUserId], references: [id])
  assignedModerator User?                    @relation("SiteVisitModerator", fields: [assignedModeratorId], references: [id])
  verificationItem  VerificationRequestItem? @relation(fields: [verificationItemId], references: [id])

  @@index([propertyId])
  @@index([assignedModeratorId])
  @@index([status])
}

model RiskEvent {
  id         String   @id @default(cuid())
  entityType String // USER, AGENCY, PROPERTY
  entityId   String
  signalType String // BURST_LISTING, GPS_MISMATCH, etc.
  scoreDelta Int
  notes      String?
  timestamp  DateTime @default(now())
  resolvedBy String? // Admin User ID

  @@index([entityType, entityId])
  @@index([signalType])
  @@index([timestamp])
}

enum BoostType {
  LISTING_BOOST
  FEATURED_LISTING
  VERIFICATION_FAST_TRACK
  PROFILE_BOOST
}

model Boost {
  id         String    @id @default(cuid())
  type       BoostType
  entityType String // PROPERTY, USER, AGENCY
  entityId   String
  startTime  DateTime  @default(now())
  endTime    DateTime
  invoiceId  String?   @unique
  isActive   Boolean   @default(true)

  invoice Invoice? @relation("BoostInvoice", fields: [invoiceId], references: [id])

  @@index([entityType, entityId])
  @@index([endTime])
}

enum LedgerEntryType {
  DEBIT
  CREDIT
  WRITE_OFF
}

model LedgerEntry {
  id             String          @id @default(cuid())
  entityType     String // USER, AGENCY, PROPERTY
  entityId       String
  type           LedgerEntryType
  amountUsdCents Int
  description    String
  metadata       Json?
  timestamp      DateTime        @default(now())

  @@index([entityType, entityId])
  @@index([timestamp])
}

model PaymentProviderSettings {
  id            String    @id @default(cuid())
  provider      String    @unique
  enabled       Boolean   @default(false)
  isDefault     Boolean   @default(false)
  isTestMode    Boolean   @default(true)
  apiKey        String? // Encrypted in production
  apiSecret     String? // Encrypted in production
  returnUrl     String?
  webhookUrl    String?
  webhookSecret String? // For webhook verification
  configJson    Json? // Additional provider-specific config
  validatedAt   DateTime?
  validatedBy   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([enabled])
  @@index([isDefault])
}

model PricingRule {
  id                     String   @id @default(cuid())
  itemType               String   @unique
  priceUsdCents          Int
  currency               Currency
  commissionPercent      Decimal  @db.Decimal(5, 2) // Platform commission %
  platformFeePercent     Decimal  @db.Decimal(5, 2) // Platform fee %
  agentSharePercent      Decimal? @db.Decimal(5, 2) // Agent share % (if applicable)
  referralSharePercent   Decimal? @db.Decimal(5, 2) // Referral share %
  rewardPoolSharePercent Decimal? @db.Decimal(5, 2) // Reward pool share %
  isActive               Boolean  @default(true)
  metadata               Json? // Additional pricing context
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([itemType, isActive])
}

model UserPaymentProfile {
  id                  String    @id @default(cuid())
  userId              String    @unique
  bankName            String?
  bankAccountNumber   String?
  bankAccountName     String?
  bankBranchCode      String?
  mobileMoneyProvider String? // Ecocash, OneMoney, etc.
  mobileMoneyNumber   String?
  paypalEmail         String?
  isVerified          Boolean   @default(false)
  verifiedAt          DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  user User @relation("UserPaymentProfile", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PaymentTransaction {
  id              String         @id @default(cuid())
  userId          String
  featureId       String? // Property ID, Agent Assignment ID, etc.
  featureType     String
  invoiceId       String?
  paymentIntentId String?
  amountCents     Int
  currency        Currency
  status          String         @default("PENDING")
  gateway         PaymentGateway
  gatewayRef      String?
  transactionRef  String         @unique
  receiptUrl      String?
  metadata        Json? // Additional context
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  user          User           @relation("PaymentTransactionUser", fields: [userId], references: [id])
  invoice       Invoice?       @relation("PaymentTransactionInvoice", fields: [invoiceId], references: [id])
  paymentIntent PaymentIntent? @relation("PaymentTransactionIntent", fields: [paymentIntentId], references: [id])

  @@index([userId, createdAt(sort: Desc)])
  @@index([featureType, featureId])
  @@index([status])
  @@index([gatewayRef])
  @@index([transactionRef])
}

model PayoutTransaction {
  id              String       @id @default(cuid())
  payoutRequestId String
  amountCents     Int
  currency        Currency
  method          PayoutMethod
  status          PayoutStatus @default(REQUESTED)
  gatewayRef      String? // External payment reference
  receiptUrl      String?
  processedAt     DateTime?
  processedBy     String? // Admin who processed
  failureReason   String?
  metadata        Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  payoutRequest PayoutRequest @relation("PayoutTransactionRequest", fields: [payoutRequestId], references: [id])

  @@index([payoutRequestId])
  @@index([status])
  @@index([gatewayRef])
}

model ReferralEarning {
  id              String    @id @default(cuid())
  referrerId      String // User who referred
  referredUserId  String? // User who was referred (optional for tracking)
  sourceType      String // PAYMENT, VERIFICATION, etc.
  sourceId        String // ID of the source transaction/event
  amountCents     Int
  currency        Currency
  status          String    @default("PENDING") // PENDING, PAID, CANCELLED
  payoutRequestId String?
  createdAt       DateTime  @default(now())
  paidAt          DateTime?

  referrer      User           @relation("ReferralEarningReferrer", fields: [referrerId], references: [id])
  payoutRequest PayoutRequest? @relation("ReferralEarningPayout", fields: [payoutRequestId], references: [id])

  @@index([referrerId, createdAt(sort: Desc)])
  @@index([status])
  @@index([sourceType, sourceId])
}

// AdSense Ingestion

model AdSenseSync {
  id        String   @id @default(cuid())
  date      DateTime @unique
  status    String // SUCCESS, FAILED
  rawJson   Json?
  createdAt DateTime @default(now())
}

model AdSenseDailyStat {
  id            String   @id @default(cuid())
  date          DateTime @unique
  impressions   Int
  clicks        Int
  revenueMicros BigInt
  currencyCode  String   @default("USD")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Phase D8: Ads and Promotions

model AdClick {
  id          String   @id @default(cuid())
  campaignId  String
  flightId    String?
  placementId String?
  userId      String?
  propertyId  String?
  sessionId   String
  clickUrl    String?
  costMicros  Int      @default(0)
  userAgent   String?
  ipAddress   String?
  countryCode String? // [Fraud]
  fingerprint String? // [Fraud]
  createdAt   DateTime @default(now())

  campaign AdCampaign @relation(fields: [campaignId], references: [id])
  user     User?      @relation("AdClickUser", fields: [userId], references: [id])
  property Property?  @relation(fields: [propertyId], references: [id])

  @@index([campaignId, createdAt])
  @@index([userId])
  @@index([propertyId])
  @@index([sessionId])
}

model AdvertiserBalanceLog {
  id           String   @id @default(cuid())
  advertiserId String
  type         String // CREDIT, DEBIT
  amountCents  Int
  reason       String // TOPUP, IMPRESSION, CLICK, REFUND
  referenceId  String? // Link to impression/click/topup
  balanceAfter Int // Balance after transaction
  createdAt    DateTime @default(now())

  advertiser Advertiser @relation(fields: [advertiserId], references: [id])

  @@index([advertiserId, createdAt(sort: Desc)])
  @@index([reason])
}

model FraudEvent {
  id                String          @id @default(cuid())
  campaignId        String
  advertiserId      String
  severity          FraudSeverity
  reason            FraudReason
  score             Int // 0-100
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime        @default(now())
  metadata          Json? // Detailed rule breakdown

  campaign   AdCampaign @relation(fields: [campaignId], references: [id])
  advertiser Advertiser @relation(fields: [advertiserId], references: [id])

  @@index([advertiserId, createdAt])
  @@index([ipAddress])
}

enum FraudSeverity {
  LOW
  MEDIUM
  HIGH
}

enum FraudReason {
  RAPID_CLICK
  SELF_CLICK
  BOT_BEHAVIOR
  GEO_MISMATCH
  AGENT_CONFLICT
  KNOWN_BAD_IP
}

// ========================================
// Supporting Models for Applications & Deals
// ========================================

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  WITHDRAWN
}

enum DealStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  EXPIRED
}

enum CommissionStatus {
  PENDING
  EARNED
  PAID
  CANCELLED
}

model Application {
  id          String            @id @default(cuid())
  propertyId  String
  userId      String
  notes       String?
  status      ApplicationStatus @default(SUBMITTED)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  user     User     @relation("UserApplications", fields: [userId], references: [id])
  deals    Deal[]

  @@unique([propertyId, userId])
  @@index([userId, status])
  @@index([propertyId, status])
}

model Deal {
  id            String     @id @default(cuid())
  propertyId    String
  tenantId      String
  landlordId    String
  agentId       String?
  applicationId String?
  status        DealStatus @default(PENDING)
  startDate     DateTime?
  endDate       DateTime?
  rentAmount    Int?
  depositAmount Int?
  currency      Currency   @default(USD)
  notes         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  property      Property     @relation(fields: [propertyId], references: [id])
  tenant        User         @relation("TenantDeals", fields: [tenantId], references: [id])
  landlord      User         @relation("LandlordDeals", fields: [landlordId], references: [id])
  agent         User?        @relation("AgentDeals", fields: [agentId], references: [id])
  application   Application? @relation(fields: [applicationId], references: [id])
  conversations Conversation[]
  commissions   Commission[]

  @@index([propertyId])
  @@index([tenantId])
  @@index([landlordId])
  @@index([agentId])
  @@index([status])
}

model Commission {
  id            String           @id @default(cuid())
  agentId       String
  propertyId    String?
  transactionId String?
  dealId        String?
  amountCents   Int
  currency      Currency         @default(USD)
  ratePercent   Decimal          @default(0) @db.Decimal(5, 2)
  status        CommissionStatus @default(PENDING)
  paidAt        DateTime?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  agent    User      @relation("UserCommissions", fields: [agentId], references: [id])
  property Property? @relation(fields: [propertyId], references: [id])
  deal     Deal?     @relation(fields: [dealId], references: [id])

  @@index([agentId, status])
  @@index([dealId])
  @@index([propertyId])
}

model Conversation {
  id            String    @id @default(cuid())
  propertyId    String?
  dealId        String?
  applicationId String?
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  property     Property?               @relation(fields: [propertyId], references: [id])
  deal         Deal?                   @relation(fields: [dealId], references: [id])
  messages     Message[]
  participants ConversationParticipant[]

  @@index([propertyId])
  @@index([dealId])
  @@index([applicationId])
  @@index([lastMessageAt(sort: Desc)])
}

model ConversationParticipant {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())
  leftAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation("ConversationParticipants", fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@index([userId])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  senderId       String
  body           String
  createdAt      DateTime @default(now())
  readAt         DateTime?

  conversation Conversation @relation(fields: [conversationId], references: [id])
  sender       User         @relation("UserMessages", fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@index([senderId])
}
